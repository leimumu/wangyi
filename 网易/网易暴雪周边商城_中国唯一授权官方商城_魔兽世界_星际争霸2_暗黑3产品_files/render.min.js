var Render=function(pat,data,opts){var _my_pat=[],_my_data={};var _setting={left_tag:'##',right_tag:'##',default_data:{},render_unknown_tag:false,default_val:'',escape_html:false,render_algorithm:_default_render_algorithm};$.extend(_setting,opts||{});_setting.default_val=_setting.default_val.toString();function _assert(condition,err_msg){if(!condition){alert(err_msg);throw new Error(err_msg);}}
function _init(){_add_pat(pat);_my_data=$.extend({},_setting.default_data,data);_my_data=_check_data(_my_data);_check_tag();};function _add_pat(p){if(typeof(p)=='string'){if(p.length>0){_my_pat.push(p);}}else{$.each(p,function(i,pi){_assert(typeof(pi)=='string',"invalid pat: must be string or list of string");if(pi.length>0){_my_pat.push(pi);}});}};function _escape_html(s){return $('<span><span>').text(s).html();}
function _check_data(d){var error_format_key_array=[];$.each(d,function(key,value){_assert(typeof(key)=="string",'invalid key: must be string');if(!/^\w+$/.test(key)){error_format_key_array.push(key);}
d[key]=value.toString();if(_setting.escape_html){d[key]=_escape_html(d[key]);}});if(error_format_key_array.length>0){alert("replace data key error: "+error_format_key_array.join(", "));throw new Error("replace data key error");}
return d;};function _check_tag(){var tag_re=/^[^\w\s]+$/;_assert(tag_re.test(_setting.left_tag),"left tag format error");_assert(tag_re.test(_setting.right_tag),"right tag format error");};function _make_exp(v){return new RegExp(_setting.left_tag+'\\s*'+v+'\\s*'+_setting.right_tag,'g');};function _unknown_tag_handler(middle_result){if(!_setting.render_unknown_tag){return middle_result;}
var patten=_make_exp('\\w*');$.each(middle_result,function(i,d){middle_result[i]=d.replace(patten,_setting.default_val);});return middle_result;};function _default_render_algorithm(source_str,data){$.each(data,function(k,v){source_str=source_str.replace(_make_exp(k),v);});return source_str;};function _render(){var result=[];$.each(_my_pat,function(i,d){result.push(_setting.render_algorithm(d,_my_data));});return _unknown_tag_handler(result)};this.get_result=function(){var s=_render();if(typeof(s)=="string"){return s;}
var res='';$.each(s,function(i,d){res+=d;});return res;};this.add_pat=function(new_pat){_add_pat(new_pat);return this;};this.reset_pat=function(new_pat){_my_pat=[];_add_pat(new_pat);return this;};this.update_data=function(d){$.extend(_my_data,_check_data(d));return this;};this.reset_data=function(d){_my_data=$.extend({},_setting.default_data,_check_data(d));return this;}
this.render_unknown_tag=function(enable,v){_assert(typeof(enable)=="boolean","enable must be boolean");_setting.render_unknown_tag=enable;if(v){_setting.default_val=v.toString();}
return this;};this.debug=function(){var s='pat:\n---------------------------------\n';$.each(_my_pat,function(i,p){s+=p+'\n';});s+='---------------------------------\n\ndata:\n---------------------------------\n';$.each(_my_data,function(k,v){s+=k+' : '+v.toString()+'\n';});s+='---------------------------------\n\noptions:\n---------------------------------\n';$.each(_setting,function(k,v){s+=k.toString()+' : '+v.toString()+'\n';});s+='---------------------------------\n\n';alert(s);};_init();};var _global_render=new Render('',{});function render(pat,data){return _global_render.reset_pat($.trim(pat)).reset_data(data).get_result();}