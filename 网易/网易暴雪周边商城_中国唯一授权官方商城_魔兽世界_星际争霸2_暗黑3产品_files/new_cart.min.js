var new_cart={init:function(){this.get_info();},ready:function(){$("#my_cart").hover(function(){$(".shopping_cart").addClass("hover");if($("#my_cart").attr("data-type")==1){$("#mini_cart").html('');$("#mini_cart").html('<div style="text-align:center;"><img src="http://wow.nos.netease.com/1/images/wow/xmas2013/loading.gif"></div>');var cart=SHOPPING_CART();var s_str_cart_info=$.toJSON(cart.load());if(cookie_check_logined()){var s_cart_info=cart.load()
if(new_cart.check_json_null(s_cart_info.products)!=0){new_cart.save_cart($.toJSON(s_cart_info),"buyer_base");}else{new_cart.copy_cloud_cart();new_cart.get_info("/script/buyer/get_cart_info");}}else{new_cart.get_info("/script/buyer/get_cart_info2",'cart_info='+s_str_cart_info);};}
$("#my_cart").attr("data-type",2);$("#my_cart").find(".mini_cart_box").show();},function(){$(".shopping_cart").removeClass("hover");$(this).find(".mini_cart_box").hide();})},get_info:function(url,data){$.ajax({data:data,url:url,dataType:"json",type:"POST",cache:false,timeout:2500,error:function(){$("#mini_cart").html('服务器请求超时');},success:function(v){$("#mini_cart").html('');var cart=SHOPPING_CART();if(!v.data){new_cart.set_cart_null();return;}
var p_list=v.data.cart_dtl.p_info;var p_pro=v.data.cart_dtl.products;var p_total=v.data.cart_dtl.total;var p_total_num=0;var p_all_num=0;var p_hide_num=0;var p_num_all=0;var array=[];var cookie_cart=v.data.cookie_cart;for(var i in p_pro){array.push(i);}
if(v.del_cart){if(v.del_cart==1){if(cookie_cart)
cart.save(cookie_cart);}}
for(var y in array){var p_pid=array[y];var p_name=p_list[array[y]].name;var p_url=p_list[array[y]].url;var p_img=p_list[array[y]].pix_path;var p_price=fen2yuan(p_pro[array[y]].real_price);var p_num=p_pro[array[y]].num;var p_per=p_list[array[y]].property;var p_perp=[]
p_total_num+=p_num;for(var z in p_per){p_perp+=z+"："+p_per[z]+" ";}
$("#mini_cart").append(render($(js_mini_cart).html(),{pro_id:p_pid,p_img:p_img,p_name:p_name,p_perp:p_perp,p_num:p_num,p_price:p_price,p_url:p_url}))}
$("#mini_cart_total").text("￥"+fen2yuan(p_total));$("#mini_cart_num").text(p_total_num);$("#shopping_cart").text(p_total_num);if(p_hide_num>0){$("#mini_cart_hide").text('(有'+p_hide_num+'种商品被隐藏)').show();}
var cloud_cart={};var del_json={};$(".mini_cart_ctrl a").click(function(){var $this_father=$(this).parent().parent();var p_id=$this_father.attr("data-cartid");var del_total=p_total-parseInt(p_pro[p_id].real_price)*p_pro[p_id].num;del_json[p_id]=0;var result_bill=new_cart.del_bill(cookie_cart,del_json);var toStr_cookie_cart=$.toJSON(result_bill);$this_father.remove();if(cookie_check_logined()){new_cart.save_cart(toStr_cookie_cart);}
cart.save(result_bill);$('#shopping_cart').html(cart.get_products_num());$('#mini_cart_num').html(cart.get_products_num());$("#mini_cart_total").text("￥"+fen2yuan(del_total));})}})},save_cart:function(toStr_cookie_cart,page){$.ajax({url:"/script/buyer/save_cart_info",data:"cart_info="+toStr_cookie_cart,type:'POST',dataType:'json',success:function(v){if(v.status!=200){alert("保存购物车错误");new_cart.set_cart_null()
return false;}
if(page=="fill_order"){$('#fill_bill_form').submit();}
if(page=="buyer_base"){new_cart.get_info("/script/buyer/get_cart_info");}}})},copy_cloud_cart:function(){$.ajax({type:"POST",url:"/script/buyer/get_cart_info",dataType:"json",success:function(v){var cloud_cookie=v.data.cookie_cart;var cart=SHOPPING_CART();cart.save(cloud_cookie);return true;}})},check_json_null:function(json){var k=0;for(var i in json){k++;}
return k;},get_products_num:function(json,want_sub_pid){var n=0;var cart=json;$.each(cart.products,function(sub_pid,num){if(!want_sub_pid||want_sub_pid==sub_pid){n+=parseInt(num);}});$.each(cart.comb,function(i,d){if(!want_sub_pid){n+=d.sub_pids.length*d.num;}else{$.each(d.sub_pids,function(i,sub_pid){if(want_sub_pid==sub_pid){n+=d.num;}});}});$.each(cart.rdp,function(i,d){if(!want_sub_pid||want_sub_pid==d.sub_pid){n+=d.num;}});$.each(cart.gb,function(i,d){if(!want_sub_pid||want_sub_pid==d.sub_pid){n+=d.num;}});return n;},del_bill:function(fill_cart,del_json){for(var i in del_json){delete fill_cart.products[i];for(var y in fill_cart.doa){for(var z in fill_cart.doa[y]){if(fill_cart.doa[y][z]==i){fill_cart.doa[y].splice(z,1);}}
if(new_cart.check_json_null(fill_cart.doa[y])==0){delete fill_cart.doa[y];}}}
return fill_cart;},save_login_cart:function(toStr_cookie_cart){if(cookie_check_logined()){$.ajax({url:"/script/buyer/save_cart_info",data:"cart_info="+JSON.stringify(toStr_cookie_cart),type:'POST',dataType:'json',success:function(v){if(v.status!=200){alert("删除商品错误");}}})}else{return;}},set_cart_null:function(){$('#shopping_cart').text('0');$.cookie('cart_info',null,{path:'/',expires:30});if(cookie_check_logined()){$.post('/script/buyer/save_cart_info','cart_info={"products":{},"comb":[],"rdp":[],"gb":[],"doa":{}}')}}}